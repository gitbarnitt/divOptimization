
---
title: "Detection Probability Sensitivity Analysis"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    df_print: tibble
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)
library(knitr)
library(kableExtra)
source("R/plot_detection_prob.R")
```

# Overview

This report presents results from a two-part sensitivity analysis using the Generalized Joint Attribute Model (GJAM) to assess plant species abundance patterns across NEON sites. The approach directly addresses core questions from the original analysis (2018â€“2019), using updated data and a Bayesian joint species distribution model.

# Analytical Goals Revisited

These analyses respond directly to goals 2 and 3 outlined in the original sensitivity analysis report:

## Goal 2: Detecting Interannual Variation
> Can we detect meaningful interannual variation in key response variables? What sample size is required?

This is addressed using **paired-year comparisons**, simulation of a 20% change, and model-based estimation of detection probability and uncertainty. The analysis evaluates how many plots are needed to reliably detect moderate ecological change.

## Goal 3: Detecting Temporal Trends
> Can long-term temporal trends in species abundance be detected at each site? What sampling intensity and species characteristics affect trend detectability?

This is now addressed using **temporal modeling across all available years**, with `year` as a covariate in the GJAM model. It enables detection of increasing or decreasing trends over time for each species.

# Two-Part Modeling Framework

This pipeline implements both components:

### Part 1: Year-to-Year Change Detection
- Compare adjacent years
- Simulate 20% increase in one year
- Estimate posterior detection probability per species
- Assess power across subsampled plots

### Part 2: Long-Term Trend Detection
- Include all years of data
- Model year as continuous covariate (`~ year`)
- Estimate posterior slope per species
- Assess CI overlap with zero and relationship with abundance

# Part 1: Year-to-Year Change Results

```{r detection-summary-plot, echo=TRUE, message=FALSE, warning=FALSE}
det_summary <- readRDS("_targets/objects/detection_summary")
plot_detection_prob(det_summary)
```

```{r summary-table, echo=FALSE}
kable(det_summary, digits = 3, caption = "Detection Probabilities with Credible Intervals") %>%
  kable_styling(full_width = FALSE)
```

# Interpreting Change Detection Sensitivity

Posterior estimates allow evaluation of whether simulated changes are detectable under different sampling scenarios.

> A species is detectable under a 20% change if the posterior 95% credible interval for detection probability does not overlap with baseline, and the lower bound is > 0.5.

```{r sample-size-detection-summary, echo=TRUE, message=FALSE, warning=FALSE}
# Placeholder summarization by sample size
summarize_detection_by_size <- function(det_data) {
  det_data %>%
    group_by(sample_size) %>%
    summarise(
      n_species = n(),
      n_detectable = sum(mean > 0.5 & lower > 0.1),
      pct_detectable = n_detectable / n_species * 100
    )
}
```

# Part 2: Long-Term Trend Analysis

```{r trend-results-placeholder, echo=TRUE, message=FALSE, warning=FALSE}
trend_summary <- readRDS("_targets/objects/trend_summary")
head(trend_summary)
```

This section uses GJAM models fitted to full multi-year data with `year` as a covariate to assess trend detectability:
- Species with high posterior slope and tight CI indicate strong trends
- Thresholds for detectability can be plotted against abundance or frequency

```{r trend-plot-placeholder, echo=FALSE}
# Example placeholder (insert real plot code)
# ggplot(trend_summary, aes(x = abundance, y = slope, color = trend_detectable)) +
#   geom_point() + geom_errorbar(aes(ymin = slope_lower, ymax = slope_upper))
```

# Summary

This two-part analysis provides:
- **Plot-level sampling guidance** to detect moderate year-to-year change
- **Species-specific trend profiles** for multi-year ecological monitoring

Future work may include:
- Species grouping by growth form or abundance class
- Assessing climate or land use drivers of trends
- Publishing detection maps or early-warning metrics

---

*Developed with `targets`, `gjam`, and `ggplot2`.*
